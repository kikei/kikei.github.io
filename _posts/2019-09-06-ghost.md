---
layout: post
title:  "Ghost2ã¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸ"
categories: blog
---

![Ghost2.30.2](/images/screenshots/2019-09-11-ghost2.png)

å°‘ã—å‰ã‹ã‚‰ [Ghost CMS](https://ghost.org/) ã‚’ä½¿ã„æ¸©æ³‰ãƒ–ãƒ­ã‚°ã‚’é‹ç”¨ã—ã¦ã„ã‚‹ã€‚

[é›¨ä¸­æ¸©æ³‰](https://yu.xaxxi.net/)

Ghost ã¯ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹ã€‚ä»¥ä¸‹ã‚’ç†ç”±ã¨ã—ã¦é¸å®šã—ãŸã‚ˆã†ãªè¨˜æ†¶ãŒã‚ã‚‹:

- Android ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‹ã‚‰æŠ•ç¨¿å¯èƒ½ã§ã‚ã‚‹ã€‚
- Node.js ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚PHP ã§ãªã„ã€‚
- Open Source Community ãŒã‚ã‚‹ã€‚
- è‡ªåˆ†ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã€ç„¡æ–™ã§ä½¿ãˆã‚‹ã€‚

ã¾ã ä½¿ã„ã“ãªã›ã¦ã„ãªã„ãŒçµæ§‹ã„ã„æ„Ÿã˜ã ã¨æ€ã†ã€‚

ã‚“ã§æœ€è¿‘ã€ç®¡ç†ç”»é¢ä¸Šéƒ¨ã« Ghost2 ã«ã™ã‚Œã°ã„ã„ã˜ã‚ƒã‚“ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
ãã“ã§ä»Šå› Ghost ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³1ã‹ã‚‰2ã«æ›´æ–°ã—ãŸã€‚æ‰‹é †ã‚’èª¿ã¹ã¦ã‚‚ã‚ã¾ã‚Šå‡ºã¦ã“ãªã„ã‹ã‚‰ã€ã“ã“ã§å…¬é–‹ã™ã‚‹ã“ã¨ã¨ã™ã‚‹ã€‚

ãªãŠ Ghost ã¯ Docker ä¸Šã§å‹•ä½œã—ã¦ã„ã‚‹ã€‚
Docker compose ã‚’ä½¿ã„ Ghost æœ¬ä½“ã¨ MySQL ã‚’åˆã‚ã›ã¦èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚

ãƒ•ãƒ­ãƒ³ãƒˆã® Web ã‚µãƒ¼ãƒãƒ¼ã«ã¯éšåˆ†ã¨å‰ã«æ§‹ç¯‰ã—ãŸ Apache ã‚’åˆ©ç”¨ã—ã¦ã„ã¦ã€Ghost ã«ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã—ã¦ã„ã‚‹ã€‚

ä¸€å¿œè¨€ã£ã¦ãŠããŒã€æœ¬è¨˜äº‹ã®é€šã‚Šã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿæ–½ã—ã¦è‰²ã€…ã†ã¾ãã„ã‹ãªã‹ã£ãŸã¨ã—ã¦ã‚‚ç§ã¯è²¬ä»»ã‚’è² ã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

### 1. ç’°å¢ƒ

ã‚µãƒ¼ãƒãƒ¼ã¯ã•ãã‚‰ã®VPSã€‚

ãƒ›ã‚¹ãƒˆ OS ã¯ CentOS 7.6:

```console
$ uname -a
Linux ns.xaxxi.net 3.10.0-957.10.1.el7.x86_64 #1 SMP Mon Mar 18 15:06:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
$ cat /etc/centos-release
CentOS Linux release 7.6.1810 (Core) 
```

Docker 1.13.1:

```console
$ docker --version
Docker version 1.13.1, build b2f74b2/1.13.1
```

Docker compose 1.24.0:

```console
$ docker-compose --version
docker-compose version 1.24.0, build 0aa59064
```

### 2. å¾“æ¥ã®ç’°å¢ƒ

ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå‰ã®è©³ç´°ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æ§ãˆã‚‹ã®ã‚’å¿˜ã‚ŒãŸã€‚ã¨ã«ã‹ã Version1 ã§ã‚ã£ãŸã€‚

docker-compose.yml ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ãŸ:

```yml
version: '3.1'
services:
  ghost:
    image: ghost:1-alpine
    restart: always
    ports:
      - 127.0.0.1:8085:2368
    volumes:
      - /home/docker/docker/ghost/data/ghost:/var/lib/ghost/content
    environment:
      # see https://docs.ghost.org/docs/config#section-running-ghost-with-config-env-variables
      url: https://yu.xaxxi.net
      database__client: mysql
      database__connection__host: db
      database__connection__user: root
      database__connection__password: PASSWORDPASSWORDPASSWORD
      database__connection__database: ghost
  db:
    image: mysql:5.7
    restart: always
    volumes:
      - /home/docker/docker/ghost/data/mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: PASSWORDPASSWORDPASSWORD
```

è¦ç‚¹ã‚’åˆ—æŒ™ã™ã‚‹:

- Ghost ã¯ localhost ã® 8085 ç•ªãƒãƒ¼ãƒˆã‚’ LISTEN ã™ã‚‹ã€‚
- Ghost ã¨ MySQL ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã‚‹ã€‚
- Ghostã€MySQL ã«ã¤ã„ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã®ç‰¹å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãã‚Œãã‚Œãƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã„ã¦ã„ã‚‹ã€‚

èµ·å‹•æ™‚ã«ã¯

```console
$ docker-compose up -d
```

ã€çµ‚äº†æ™‚ã«ã¯

```console
$ docker-compose down
```

ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

### 3. ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
 
å¿µã®ãŸã‚è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å…¨ã¦ã¨ã£ã¦ãŠãã€‚
ä»Šå›ã€ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã¯ä½¿ã‚ãšã«æ¸ˆã‚“ã ãŸã‚ã€ãƒªã‚¹ãƒˆã‚¢ã«ã¤ã„ã¦ã¯ç‰¹ã«è§¦ã‚Œãªã„ã€‚

Docker ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ã—ã¦æŒ‡å®šã—ã¦ã„ã‚‹ data ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¸¸ã”ã¨ BZIP2 ã«ã—ãŸã€‚
Permission ã®é–¢ä¿‚ã§ root ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚

```console
$ su -
# cd /home/docker/docker/ghost
# tar jcvf data-20190905.tar.bz2 data
# ls
data  data-20190905.tar.bz2  docker-compose.yml  run.sh
# exit
```

### 4. Ghost1 ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°

ã“ã®æ‰‹é †ãŒå¿…è¦ã‹ã¯ã‚ã‹ã‚‰ãªã„ãŒå¿µã®ç‚ºã«ã‚„ã£ãŸã€‚
ã„ããªã‚Š Ghost2 ã«æ›´æ–°ã™ã‚‹ã®ã§ã¯ãªãã€ã„ã£ãŸã‚“ Ghost1 ã‚’æœ€æ–°ã«ã—ã¦ãŠãã“ã¨ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚’å°‘ãªãã—ã‚ˆã†ã¨ã„ã†ã“ã¨ã ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã„ã£ãŸã‚“å‰Šé™¤ã—ã€`pull` ã§æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã€‚

```console
$ docker-compose down
$ docker-compose pull
```

ãã®å¾Œ Ghost1 ã‚’èµ·å‹•ã—ã¦å•é¡Œç„¡ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºã‹ã‚ãŸã€‚
ãªã‚“ãªã‚‰ã“ã®ã‚ã¨å†ã³ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦ã‚‚ã„ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãŒèµ°ã£ãŸã‚ˆã†ãªé›°å›²æ°—ãŒã‚ã£ãŸã‚‰å†ä½œæˆã™ã‚‹ã¹ãã ã€‚

```console
$ docker-compose up -d
```

### 5. Ghost2 ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—

docker-compose.yml ã‚’æ›¸ãæ›ãˆã¦ Ghost2 ã‚’ä½¿ã†ã‚ˆã†ã«ã—ãŸã ã‘ã€‚

æ›¸ãæ›ãˆå¾Œã® docker-compose.yml ã®ä¸­èº«ã¯ä»¥ä¸‹:

```yml
version: '3.1'
services:
  ghost:
    image: ghost:2-alpine
    restart: always
    ports:
      - 127.0.0.1:8085:2368
    volumes:
      - /home/docker/docker/ghost/data/ghost:/var/lib/ghost/content
    environment:
      # see https://docs.ghost.org/docs/config#section-running-ghost-with-config-env-variables
      url: https://yu.xaxxi.net
      database__client: mysql
      database__connection__host: db
      database__connection__user: root
      database__connection__password: PASSWORDPASSWORDPASSWORD
      database__connection__database: ghost
  db:
    image: mysql:5.7
    restart: always
    volumes:
      - /home/docker/docker/ghost/data/mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: PASSWORDPASSWORDPASSWORD
```

`ghost` ã® `image` ã‚’ `ghost:2-alpine` ã«ã—ãŸã€‚

ãã‚Œã§ã¾ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã„ã£ãŸã‚“å‰Šé™¤ã—ã€`pull` ã§æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã€‚

```console
$ docker-compose down
$ docker-compose pull
```

ã“ã‚Œã§ Ghost2 ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå–å¾—ã•ã‚ŒãŸã€‚
ã“ã®çŠ¶æ…‹ã§å†ã³ Ghost ã‚’èµ·å‹•ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŒè¡Œã‚ã‚ŒãŸã€‚

```console
$ docker-compose up -d
```

å°‘ã—å¾…ã£ã¦ã‹ã‚‰ `/admin` ã‚’ Web ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã‘ã°ã‚ˆã„ã€‚

ãªãŠã€ã„ããªã‚Šãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸæ™‚ã«ã¯ 504 Service Unavailable ãŒå‡ºåŠ›ã•ã‚ŒãŸã€‚

### 5. Unable to enable SKIP DNAT rule

æ¡ä»¶ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒã€Docker ã‚¤ãƒ¡ãƒ¼ã‚¸èµ·å‹•æ™‚ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã£ãŸã€‚

```console
$ docker-compose up -d
Creating network "ghost_default" with the default driver
ERROR: Failed to Setup IP tables: Unable to enable SKIP DNAT rule:  (iptables failed: iptables --wait -t nat -I DOCKER -i br-7d2f50277821 -j RETURN: iptables: No chain/target/match by that name.
 (exit status 1))
 ```
 
 ã“ã®ã‚ˆã†ãªã¨ãã«ã¯ Docker ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¦ã‚„ã‚Œã°ç›´ã£ãŸã€‚
 
 ```console
# systemctl restart docker
```

### 6. å‚è€ƒãƒšãƒ¼ã‚¸

- [Upgrade to Ghost 2\.0 \- Tutorial](https://ghost.org/faq/upgrade-to-ghost-2-0/)
- [GitHub \- TryGhost/Ghost: ğŸ‘» The \#1 headless Node\.js CMS for professional publishing](https://github.com/TryGhost/Ghost)
